<html>
<head>
 <title>Historiske vegreferanser</title>


	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!--    
<script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous">
</script>
--> 
 <script src="lib/jquery-3.4.1.min.js"></script>
 <script src="lib/jquery-dropdown-datepicker.min.js"></script>

 <link rel="stylesheet" href="lib/leaflet/leaflet.css">
 <link rel="stylesheet" href="css/vegrefcss.css">
 
 <script src="lib/leaflet/leaflet.js" ></script>
 <script src="lib/proj4-compressed.js"></script>
 <script src="lib/proj4leaflet.js"></script>

</head>
<body onload="sjekkUrlParams()" >

<p>Klikk på en veg i kartet for å se tidsutvikling av vegreferanse</p>

<div id="datovelger"><p>Dato som skal fremheves:<input type="text" id="date"></p></div>

<div id="vegreferansevelger"><p>


<form>

  HP:
  <input id="hp" type="number" name="quantity" min="1" max="999">
  M:
  <input id="meter" type="number" name="quantity" min="1" max="99999">

</form>


</p></div>

<div id="map" class="map map-home" style="height: 50%; width=100%;"></div>

<div id="resultater">
      <table id="vegreferanseTabell"
              class="table table-bordered
                     table-condensed">

</div> 

<p id="bruksanvisning1">Klikk på en veg i kartet for å se historikken akkurat der</p>. 



<!--
<p>Vi fremhever den vegreferansen gyldig i dag, og eventuelt for den datoen du har valgt.</p>
-->

<script>
/* Datovelger */
$(function(){

    myUrl = window.location.href; 
    var dato = getUrlParameter(myUrl, "dato");
    var godkjent = sjekkdato( dato); 
    if (!godkjent) { 

        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
        var yyyy = today.getFullYear();
        dato = yyyy + '-' + mm + '-' + dd; 

    }

    $('#date').dropdownDatepicker({ 'defaultDate' : dato } );
 
});

function sjekkdato( mystring) {
// Sjekker om dato er på format 2018-12-30 
    
    var godkjent = false; 
    var myArr = mystring.split( '-'); 
    if (myArr.length == 3) {
        var yyyy = parseInt( myArr[0] ); 
        var mm = parseInt( myArr[1] ); 
        var dd = parseInt( myArr[2] ); 
        
        if (!isNaN( yyyy ) && !isNaN( mm ) && !isNaN( dd)  && 
            yyyy > 1949 && yyyy < 1e4 && mm > 0 && mm < 13 && dd > 0 && dd < 32) {
                godkjent = true; 
        }
        
    }

    return godkjent

}

/*
Leser URL parametre ved oppstart 
*/
function sjekkUrlParams() {
  
    myUrl = window.location.href; 
    var visningstype = getUrlParameter(myUrl, "kartvisning"); 
    var dato = getUrlParameter(myUrl, "dato");
       
    
    if (visningstype === "posisjon") { 
        console.log( "Viser tidsutvikling vegreferanse i fast posisjon" ); 
        var ost  = parseFloat( getUrlParameter( myUrl, "ost")) ;
        var nord = parseFloat( getUrlParameter( myUrl, "nord")); 
        var minDato = getUrlParameter( myUrl, "dato"); 
        
        if (!isNaN( ost) && !isNaN(nord)) {
            console.log( "Viser tidsutvikling i posisjon" + ost + "ost " + nord + "nord" )
            vispunktdata( ost, nord, false, true, minDato); 
            
        } else {
            console.log( "ikke happy ned nord/ost parametre"); 
        }
        
        if (sjekkdato(minDato)) {
            console.log( "Fremhever dato: " + minDato);
        }
        
    } else if (visningstype === "vegreferanse" ) {
        console.log( "Viser ulike posisjoner for en gitt vegreferanse") ;
    } else {
        console.log( "Parameter kartvisning ikke (korrekt) angitt, posisjon eller vegreferanse") ;
    }

}


/* URL manipulation functions 

From https://blog.bitscry.com/2018/08/17/getting-and-setting-url-parameters-with-javascript/

*/ 

function getUrlParameter(url, parameter) {
    parameter = parameter.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?|&]' + parameter.toLowerCase() + '=([^&#]*)');
    var results = regex.exec('?' + url.toLowerCase().split('?')[1]);
    return results === null ? 'BOM' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}


function endreUrlParametre( params) {
/* Oppdaterer URL parametre slik at den er a jour med de brukervalgene som er a jour
    Legger også eksisterende URL til nettleser-historikken.
*/ 

    // Dele URL i statisk del og eventuelle parametre-del
    var oldUrl = window.location.href.split('?'); 
    var myPathName = window.location.pathname; 

    // Endre  URL via html5 window.historikk-funksjon 
    var newUrl = oldUrl[0]; 
    const myParams = Object.entries(params);  
    for (const [myKey, myVal] of myParams) {
        newUrl = setUrlParameter( newUrl, myKey, myVal); 
    }
    var newUrlParams = newUrl.split('?')[1];
    window.history.pushState({}, document.title, myPathName + '?' + newUrlParams); 

}

function setUrlParameter(url, key, value) {
    var key = encodeURIComponent(key),
        value = encodeURIComponent(value);

    var baseUrl = url.split('?')[0],
        newParam = key + '=' + value,
        params = '?' + newParam;

    if (url.split('?')[1] == undefined){ // if there are no query strings, make urlQueryString empty
        urlQueryString = '';
    } else {
        urlQueryString = '?' + url.split('?')[1];
    }

    // If the "search" string exists, then build params from it
    if (urlQueryString) {
        var updateRegex = new RegExp('([\?&])' + key + '[^&]*');
        var removeRegex = new RegExp('([\?&])' + key + '=[^&;]+[&;]?');

        if (typeof value === 'undefined' || value === null || value === "") { // Remove param if value is empty
            params = urlQueryString.replace(removeRegex, "$1");
            params = params.replace(/[&;]$/, "");
            
        } else if (urlQueryString.match(updateRegex) !== null) { // If param exists already, update it
            params = urlQueryString.replace(updateRegex, "$1" + newParam);
            
        } else if (urlQueryString=="") { // If there are no query strings
            params = '?' + newParam;
        } else { // Otherwise, add it to end of query string
            params = urlQueryString + '&' + newParam;
        }
    }

    // no parameter was set so we don't need the question mark
    params = params === '?' ? '' : params;

    return baseUrl + params;
}





var crs = new L.Proj.CRS('EPSG:25833',
    '+proj=utm +zone=33 +ellps=GRS80 +units=m +no_defs ',
    {
        origin: [-2500000.0, 9045984.0],
        resolutions: [
            21674.7100160867, 
            10837.35500804335, 
            5418.677504021675, 
            2709.3387520108377, 
            1354.6693760054188, 
            677.3346880027094, 
            338.6673440013547, 
            169.33367200067735, 
            84.66683600033868, 
            42.33341800016934, 
            21.16670900008467, 
            10.583354500042335, 
            5.291677250021167, 
            2.6458386250105836, 
            1.3229193125052918, 
            0.6614596562526459, 
            0.33072982812632296
        ]
    });



var nvdbcache = 'https://nvdbcache.geodataonline.no/arcgis/rest/services/Trafikkportalen/GeocacheTrafikkJPG/MapServer/tile/{z}/{y}/{x}'

var bakgrunnskart = new L.tileLayer(nvdbcache, {
    maxZoom: 16,
    minZoom: 0,	
    subdomains: '123456789',
    continuousWorld: true,
    detectRetina: false, 
	attribution: '&copy; NVDB, Geovekst, kommmuene. Kartbakgrunn utenfor Norge: Open street map contributors'
});

var map = new L.map('map', {
    zoom: 6,
    center: [63.43, 10.40],
    crs: crs, 
    continuousWorld: true,
    worldCopyJump: false,
    zoomControl: false,
    attributionControl: true,
   layers: [bakgrunnskart]
})

L.control.zoom({
     position:'topleft'
}).addTo(map);

function lagPunktHistorikkTabell( jsondata) {

    $("#vegreferanseTabell").empty(); 
    
    var arrayLength = jsondata['features'].length;
    for (var i = 0; i < arrayLength; i++) {

        if ($("#vegreferanseTabell tbody").length == 0) {
          $("#vegreferanseTabell").append("<thead>" + 
          "<th><em>Vegreferanse</em></th>" + 
          "<th><em>Gyldig fra</em></th>" + 
          "<th><em>Gyldig til</em></th></tr></thead><tbody></tbody>");
        }
          
        $("#bruksanvisning1").remove();
        // Append product to the table
        var myTableRow = "<tr " + 'class="'  + jsondata['features'][i]['properties']['fremhev'] +  '">' +
            "<td>" + jsondata['features'][i]['properties']['vegref'] + "</td>" +
            "<td>" + jsondata['features'][i]['properties']['fradato'] + "</td>" +
            "<td>" + jsondata['features'][i]['properties']['tildato'] + "</td>" +
          "</tr>"; 
        $("#vegreferanseTabell tbody").append(myTableRow);
    }
    
}    


function vispunktdata( ost, nord, oppdaterUrl, sentrerKart, valgtDato) {
/*
ost, nord = UTM koordinater, sone 33 (EPSG:25833
oppdaterUrl : boolean. Angir om vi skal oppdatere nettleser-adressen og -historikken.
sentrerKart : boolean. Sentrerer kartet i angitt posisjon. 
    Brukes når posisjon angis i URL, men du sentrerer IKKE ved klikk i kartet. 

*/

    var mindato = "";
    if (sjekkdato(valgtDato)) {
        mindato = valgtDato; 
    
    } else {

        mindato =  document.getElementById("date").value;
        
    }
   if (sjekkdato(mindato)) {

       historikkApi = 'https://python.ltglahn.no/posisjon?ost='+ost +
        '&nord='+nord + '&dato=' + mindato;
   
   } else { 

       historikkApi = 'https://python.ltglahn.no/posisjon?ost='+ost +
        '&nord='+nord;
    
    }
    console.log(historikkApi);
    var xhr = new XMLHttpRequest();
    xhr.open("GET", historikkApi, true);
    xhr.send();
	xhr.onreadystatechange = function () {
    
         if (xhr.readyState == 4 && xhr.status == 200) {
            var respons = JSON.parse(xhr.responseText);
            lagPunktHistorikkTabell( respons); 

            if (respons['features'].length === 0) {
                console.log( "Ingen veger her" + ost + " , ", + nord ); 
            } else { 
            
                var coords = respons['features'][0]['geometry']['coordinates']
                props = respons['features'][0]['properties']
            
                var mittPunkt =  crs.projection.unproject( L.point( coords[0], coords[1] ));

                if (sentrerKart === true) {
                    map.setView(mittPunkt, 10); 
                }
                
                var kartklikkMarker =  L.popup();
                kartklikkMarker
                               .setLatLng( mittPunkt)
                               .setContent( props['vegref'] ) 
                               .openOn(map); 
                // Oppdaterer nettleser adressefelt og historikk? 
                if (oppdaterUrl === true) {
                
                    if (sjekkdato(mindato)) { 
                        endreUrlParametre( { 'kartvisning' : 'posisjon', 
                                            'ost' : coords[0], 'nord' : coords[1], 'dato' : mindato }); 
                    } else {
                        endreUrlParametre( { 'kartvisning' : 'posisjon', 
                                            'ost' : coords[0], 'nord' : coords[1] }); 
                    }
                }
            } 
        }
    }

}


function onMapClick(e) {

    var latlon = e.latlng;
    utm33 = crs.projection.project( latlon );  
        
    vispunktdata( utm33.x, utm33.y, true, false); 
 
}

map.on( 'click', onMapClick); 
$('.leaflet-container').css('cursor','crosshair');



</script>
</body>
</html>